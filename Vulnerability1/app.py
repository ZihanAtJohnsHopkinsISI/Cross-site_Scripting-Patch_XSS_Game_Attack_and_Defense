from flask import Flask, request, render_template_string, make_response
from markupsafe import escape

app = Flask(__name__)

page_header = """
<!doctype html>
<html>
  <head>
    <!-- Internal game scripts/styles, mostly boring stuff -->
    <script src="static/game-frame.js"></script>
    <link rel="stylesheet" href="static/game-frame-styles.css" />
  </head>

  <body id="level1">
    <img src="static/logos/level1.png">
      <div>
"""

page_footer = """
    </div>
  </body>
</html>
"""

main_page_markup = """
<form action="" method="GET">
  <input id="query" name="query" value="Enter query here..."
    onfocus="this.value=''">
  <input id="button" type="submit" value="Search">
</form>
"""

# @app.route('/')
# def home():
#     return "Hello, World!"

# @app.route('/greet/<name>')
# def greet(name):
#     return f"Hello, {name}!"


# In this part before revise, when inject:
# <script>alert("Hello")</script>, it will has a alert:


@app.route('/', methods=['GET'])
def main_page():
    if not request.args.get('query'):
        # Show main search page
        content = page_header + main_page_markup + page_footer
    else:
        query = request.args.get('query', '[empty]')
        
        # Our search engine broke, we found no results :-(
        message = f"Sorry, no results were found for <b>{query}</b>."
        message += " <a href='?'>Try again</a>."

        # Display the results page
        content = page_header + message + page_footer
        
    response = make_response(render_template_string(content))
    # Patchment:
    response.headers["X-XSS-Protection"] = "1"

    # CSP
    # response.headers["Content-Security-Policy"] = "default-src 'self'"
    return response

if __name__ == '__main__':
    app.run(debug=True, port=5001)